<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>VC復号Webアプリ</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2em; }
    canvas { border: 1px solid #aaa; margin-top: 1em; }
  </style>
</head>
<body>
  <h2>出席確認（VC合成）</h2>
  <p>Share A画像をアップロード：</p>
  <input type="file" id="shareA" accept="image/*"><br><br>
  <p>Share B画像をアップロード：</p>
  <input type="file" id="shareB" accept="image/*"><br><br>
  <button onclick="combineShares()">合成してQRを読み取る</button>
  <button id="downloadBtn" style="display:none;" onclick="downloadCombined()">合成結果をダウンロード</button>
  <canvas id="canvas"></canvas>
  <p id="result">QRコード：未読取</p>

  <!-- QRコード解析ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  
  <script>
  // 画像読み込み
  function loadImage(file) {
      return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = e => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = reject;
              img.src = e.target.result;
          };
          reader.readAsDataURL(file);
      });
  }

  async function combineShares() {
      const fileA = document.getElementById('shareA').files[0];
      const fileB = document.getElementById('shareB').files[0];
      if (!fileA || !fileB) {
          alert("両方のShare画像を選択してください");
          return;
      }

      const imgA = await loadImage(fileA);
      const imgB = await loadImage(fileB);

      // === 元画像サイズにCanvasを合わせる ===
      const width = Math.max(imgA.width, imgB.width);
      const height = Math.max(imgA.height, imgB.height);

      const canvas = document.getElementById('canvas');
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext('2d');

      // 1枚目描画
      ctx.drawImage(imgA, 0, 0, width, height);
      const imgDataA = ctx.getImageData(0, 0, width, height);

      // 2枚目描画（オフスクリーン）
      const tmpCanvas = document.createElement('canvas');
      tmpCanvas.width = width;
      tmpCanvas.height = height;
      const tmpCtx = tmpCanvas.getContext('2d');
      tmpCtx.drawImage(imgB, 0, 0, width, height);
      const imgDataB = tmpCtx.getImageData(0, 0, width, height);

      // === ピクセルごとの乗算合成 + 明るさ補正 ===
      const dataA = imgDataA.data;
      const dataB = imgDataB.data;
      const brightnessFactor = 1.6; // 明るさ補正係数（1.0〜2.0推奨）
      for (let i = 0; i < dataA.length; i += 4) {
          let r = (dataA[i]   * dataB[i])   / 255;
          let g = (dataA[i+1] * dataB[i+1]) / 255;
          let b = (dataA[i+2] * dataB[i+2]) / 255;

          // 明るさ補正
          r = Math.min(255, r * brightnessFactor);
          g = Math.min(255, g * brightnessFactor);
          b = Math.min(255, b * brightnessFactor);

          dataA[i]   = r;
          dataA[i+1] = g;
          dataA[i+2] = b;
          dataA[i+3] = 255; // アルファは常に不透明
      }
      ctx.putImageData(imgDataA, 0, 0);

      // === QRコード読み取り ===
      const combinedData = ctx.getImageData(0, 0, width, height);
      const code = jsQR(combinedData.data, width, height);
      document.getElementById('result').textContent = code ? "QRコード：" + code.data : "QRコード：読取失敗";

      // ダウンロードボタン表示
      document.getElementById('downloadBtn').style.display = "inline-block";
  }

  function downloadCombined() {
      const canvas = document.getElementById('canvas');
      const link = document.createElement('a');
      link.download = "combined.png";
      link.href = canvas.toDataURL("image/png");
      link.click();
  }
  </script>
</body>
</html>
